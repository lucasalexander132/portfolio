---
phase: 11-entry-display
plan: 03
type: execute
wave: 3
depends_on: ["11-01", "11-02"]
files_modified:
  - src/app/updates/[slug]/page.tsx
  - src/components/updates/EntryArticle.tsx
  - src/components/updates/PostNavigation.tsx
  - src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "Visiting /updates/[slug] renders a full article with header, body, and post navigation"
    - "Article header shows meta row (date + dot + filled tag chip), Fraunces 40px title, and muted subtitle"
    - "Markdown body renders with rich typography: styled paragraphs, headings, blockquotes, lists, code blocks with syntax highlighting and copy button, and horizontal rules"
    - "Code blocks have a dark background with language label header and working copy button"
    - "Entries with a link field display an amber external link row"
    - "Post navigation shows prev/next links, hiding unavailable directions entirely"
    - "Invalid slugs show Next.js 404 page"
  artifacts:
    - path: "src/app/updates/[slug]/page.tsx"
      provides: "Detail page route with generateMetadata"
      contains: "getUpdateBySlug"
    - path: "src/components/updates/EntryArticle.tsx"
      provides: "Article layout with header, body, link row"
      min_lines: 50
    - path: "src/components/updates/PostNavigation.tsx"
      provides: "Prev/next navigation links"
      min_lines: 20
    - path: "src/app/globals.css"
      provides: ".prose-updates styles for article body"
      contains: "prose-updates"
  key_links:
    - from: "src/app/updates/[slug]/page.tsx"
      to: "src/lib/updates.ts"
      via: "getUpdateBySlug + getAdjacentEntries"
      pattern: "getUpdateBySlug"
    - from: "src/components/updates/EntryArticle.tsx"
      to: "src/app/globals.css"
      via: ".prose-updates class on article body"
      pattern: "prose-updates"
    - from: "src/components/updates/PostNavigation.tsx"
      to: "/updates/[slug]"
      via: "Link with viewTransition"
      pattern: "Link.*viewTransition"
---

<objective>
Build the /updates/[slug] detail page with EntryArticle component (rich markdown rendering), PostNavigation (prev/next), and .prose-updates CSS styles. Handle the link field display and code block copy button.

Purpose: Deliver the reading experience for individual update entries with polished typography and navigation.
Output: Working detail page at /updates/[slug] with full article rendering, post navigation, and 404 handling.
</objective>

<execution_context>
@/Users/lucasalexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucasalexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-entry-display/11-01-SUMMARY.md
@src/lib/updates.ts
@src/app/globals.css
@src/app/updates/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create detail page route, EntryArticle, and PostNavigation</name>
  <files>src/app/updates/[slug]/page.tsx, src/components/updates/EntryArticle.tsx, src/components/updates/PostNavigation.tsx</files>
  <action>
**src/app/updates/[slug]/page.tsx** -- Server component:

1. Import `getUpdateBySlug`, `getAdjacentEntries` from `@/lib/updates`, `notFound` from `next/navigation`, `EntryArticle`, and `Metadata` type.

2. `generateMetadata` function:
   ```typescript
   export async function generateMetadata({ params }: { params: Promise<{ slug: string }> }): Promise<Metadata> {
     const { slug } = await params
     const entry = await getUpdateBySlug(slug)
     if (!entry) return { title: 'Not Found' }
     return {
       title: `${entry.title} | Civix Solutions`,
       description: entry.summary,
     }
   }
   ```

3. Default export page component:
   ```typescript
   export default async function UpdateDetailPage({ params }: { params: Promise<{ slug: string }> }) {
     const { slug } = await params
     const entry = await getUpdateBySlug(slug)
     if (!entry) notFound()
     const adjacent = await getAdjacentEntries(slug)
     return <EntryArticle entry={entry} adjacent={adjacent} />
   }
   ```

**src/components/updates/EntryArticle.tsx** -- Client component (`'use client'`):

1. Props:
   ```typescript
   interface EntryArticleProps {
     entry: UpdateEntry
     adjacent: {
       prev: { slug: string; title: string } | null
       next: { slug: string; title: string } | null
     }
   }
   ```

2. Layout structure (wrapped in `<main className="max-w-3xl mx-auto px-6 py-12">`):

   a. **Back row:** Link back to /updates with left arrow icon (ChevronLeft from lucide-react) + "All updates" text. Use `viewTransition` on Link. Style: text-text-muted hover:text-amber-500 transition-colors, flex items-center gap-1, mb-8.

   b. **Article header:**
      - Meta row: Same date formatting helper as EntryListItem (static month lookup). Date (text-text-muted text-sm) + bullet dot (text-text-muted mx-2) + TagChip (import from ./TagChip)
      - Title: `<h1 className="font-serif text-[40px] leading-tight text-text-primary mt-3 mb-3">`
      - Subtitle/lead: `<p className="font-sans text-[17px] text-text-muted leading-relaxed">{entry.summary}</p>`

   c. **Divider:** `<hr className="border-[#2D3140] my-8" />`

   d. **Article body:** Render the server-generated HTML body. The content comes from trusted local markdown files processed through the unified pipeline (gray-matter + remark + rehype), not from user input. Use `<div className="prose-updates" dangerouslySetInnerHTML={{ __html: entry.body }} />`. The .prose-updates class handles all typography styling (defined in globals.css).

   e. **Link field (conditional):** If `entry.link` exists, render after the article body:
      ```tsx
      {entry.link && (
        <div className="flex items-center gap-2 mt-8 mb-4">
          <ExternalLink className="w-4 h-4 text-amber-500" />
          <a
            href={entry.link.url}
            target="_blank"
            rel="noopener noreferrer"
            className="text-amber-500 hover:text-amber-400 transition-colors font-sans"
          >
            Visit {entry.link.label} &rarr;
          </a>
        </div>
      )}
      ```
      Import ExternalLink from lucide-react.

   f. **Divider:** `<hr className="border-[#2D3140] my-8" />`

   g. **PostNavigation:** `<PostNavigation prev={adjacent.prev} next={adjacent.next} />`

3. **Copy button for code blocks:** Add a `useEffect` that runs after mount to inject copy buttons into all `pre` elements within `.prose-updates`:
   ```typescript
   useEffect(() => {
     const codeBlocks = document.querySelectorAll('.prose-updates pre')
     codeBlocks.forEach((pre) => {
       if (pre.querySelector('.copy-button')) return
       const button = document.createElement('button')
       button.className = 'copy-button'
       button.textContent = 'Copy'
       button.addEventListener('click', async () => {
         const code = pre.querySelector('code')
         if (code) {
           await navigator.clipboard.writeText(code.textContent || '')
           button.textContent = 'Copied!'
           setTimeout(() => { button.textContent = 'Copy' }, 2000)
         }
       })
       pre.appendChild(button)
     })
   }, [])
   ```

4. Date formatting: Use the same static MONTHS array approach as in EntryListItem. Define locally. Do NOT use toLocaleDateString.

**src/components/updates/PostNavigation.tsx** -- Client component:

1. Props:
   ```typescript
   interface PostNavigationProps {
     prev: { slug: string; title: string } | null
     next: { slug: string; title: string } | null
   }
   ```

2. Render a flex row (`flex justify-between items-start gap-4`):
   - Left side: If `prev` exists, show a Link to `/updates/${prev.slug}` with viewTransition:
     - Small label: "Newer" (text-xs text-text-muted uppercase tracking-wide)
     - Title: prev.title (text-sm text-text-primary hover:text-amber-500 transition-colors)
     - Left arrow icon (ChevronLeft from lucide-react)
   - Right side: If `next` exists, show a Link to `/updates/${next.slug}` with viewTransition:
     - Small label: "Older" (text-xs text-text-muted uppercase tracking-wide, text-right)
     - Title: next.title (text-sm text-text-primary hover:text-amber-500 transition-colors, text-right)
     - Right arrow icon (ChevronRight from lucide-react)
   - IMPORTANT: Hide the unavailable direction entirely -- never show disabled/grayed-out states. If only next exists, use `ml-auto` to push it right.
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - `npm run build` succeeds
   - Grep page.tsx for `getUpdateBySlug`, `notFound`, `await params`
   - Grep EntryArticle.tsx for `prose-updates`, `entry.link`
   - Grep EntryArticle.tsx for `useEffect`, `copy-button`, `clipboard` (confirms copy-button implementation)
   - Grep PostNavigation.tsx for `viewTransition`, `Newer`, `Older`
  </verify>
  <done>Detail page renders at /updates/[slug] with article header, rich body, link field, post navigation. Code blocks have copy button injected via useEffect. Invalid slugs 404.</done>
</task>

<task type="auto">
  <name>Task 2: Add .prose-updates CSS styles for rich article body rendering</name>
  <files>src/app/globals.css</files>
  <action>
Add the following styles inside the `@layer components` section of globals.css, after the existing shadow-elevation styles. These style the rendered HTML from the trusted markdown pipeline.

```css
/* Rich markdown article body styles for /updates/[slug] detail pages */
.prose-updates {
  font-family: var(--font-sans);
  font-size: 16px;
  color: #C4B89A;
  line-height: 1.75;
}

.prose-updates p {
  margin-bottom: 1.25em;
  max-width: 65ch;
}

.prose-updates h2 {
  font-family: var(--font-serif);
  font-size: 28px;
  font-weight: 700;
  color: #EDE5D4;
  margin-top: 2em;
  margin-bottom: 0.75em;
  line-height: 1.3;
}

.prose-updates h3 {
  font-family: var(--font-serif);
  font-size: 22px;
  font-weight: 600;
  color: #EDE5D4;
  margin-top: 1.5em;
  margin-bottom: 0.5em;
  line-height: 1.4;
}

.prose-updates blockquote {
  border-left: 3px solid #D4A843;
  padding-left: 1em;
  margin: 1.5em 0;
  font-style: italic;
  color: var(--color-text-muted);
}

.prose-updates blockquote p {
  margin-bottom: 0.5em;
}

.prose-updates ul {
  list-style: none;
  padding-left: 1.25em;
  margin: 1em 0;
}

.prose-updates ul li {
  position: relative;
  padding-left: 0.25em;
  margin-bottom: 0.5em;
}

.prose-updates ul li::before {
  content: '';
  position: absolute;
  left: -1em;
  top: 0.65em;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: #D4A843;
}

.prose-updates ol {
  list-style: none;
  padding-left: 1.25em;
  margin: 1em 0;
  counter-reset: list-counter;
}

.prose-updates ol li {
  position: relative;
  padding-left: 0.25em;
  margin-bottom: 0.5em;
  counter-increment: list-counter;
}

.prose-updates ol li::before {
  content: counter(list-counter) '.';
  position: absolute;
  left: -1.5em;
  color: #D4A843;
  font-weight: 600;
  font-size: 14px;
}

/* Code blocks (rehype-pretty-code output) */
.prose-updates pre {
  position: relative;
  background-color: #0D0F14;
  border-radius: 8px;
  margin: 1.5em 0;
  overflow: hidden;
}

.prose-updates pre > code {
  display: block;
  padding: 1em 1.25em;
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.6;
  overflow-x: auto;
}

.prose-updates [data-rehype-pretty-code-figure] {
  position: relative;
}

.prose-updates [data-rehype-pretty-code-title] {
  background-color: #0D0F14;
  border-bottom: 1px solid #2D3140;
  padding: 0.5em 1.25em;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--color-text-muted);
  border-radius: 8px 8px 0 0;
}

.prose-updates [data-rehype-pretty-code-title] + pre {
  border-radius: 0 0 8px 8px;
}

/* Inline code */
.prose-updates :not(pre) > code {
  background-color: #1A1D26;
  color: #D4A843;
  padding: 0.15em 0.4em;
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 13px;
}

/* Copy button for code blocks (injected via useEffect in EntryArticle) */
.prose-updates pre .copy-button {
  position: absolute;
  top: 0.5em;
  right: 0.5em;
  background: #2D3140;
  border: 1px solid #3D4150;
  border-radius: 4px;
  padding: 0.25em 0.5em;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--color-text-muted);
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.15s;
}

.prose-updates pre:hover .copy-button {
  opacity: 1;
}

.prose-updates pre .copy-button:hover {
  color: var(--color-text-primary);
  background: #3D4150;
}

/* Images */
.prose-updates img {
  max-width: 100%;
  border-radius: 8px;
  border: 1px solid #2D3140;
  margin: 1.5em 0 0.5em;
}

.prose-updates img + em,
.prose-updates figcaption {
  display: block;
  font-style: italic;
  color: var(--color-text-muted);
  font-size: 14px;
  margin-bottom: 1.5em;
}

/* Horizontal rules */
.prose-updates hr {
  border: none;
  border-top: 1px solid #2D3140;
  margin: 2em 0;
}

/* Links */
.prose-updates a {
  color: #D4A843;
  text-decoration: underline;
  text-underline-offset: 2px;
  transition: color 0.15s;
}

.prose-updates a:hover {
  color: #E8C060;
}

/* Emphasis */
.prose-updates strong {
  color: #EDE5D4;
  font-weight: 600;
}

.prose-updates em {
  font-style: italic;
}
```
  </action>
  <verify>
   - `npm run build` succeeds
   - Grep globals.css for `prose-updates`, `#0D0F14`, `#D4A843`, `copy-button`
  </verify>
  <done>Article body renders with full rich typography: styled paragraphs, headings, blockquotes, amber-bulleted lists, syntax-highlighted code blocks with copy button, inline code, images, and horizontal rules</done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- /updates/[slug] route renders for valid slugs (e.g., /updates/2025-06-codex-grove-launch)
- Invalid slugs return 404
- Article header: meta row + 40px Fraunces title + muted subtitle
- Article body: prose-updates class applies all typography styles
- Code blocks: dark bg, syntax highlighting, copy button appears on hover
- Link field: amber external link row when entry has link field
- Post navigation: prev/next links, unavailable direction hidden entirely
- Back link navigates to /updates
</verification>

<success_criteria>
- Detail page at /updates/[slug] with SEO metadata
- Article header with date, tag chip, title, subtitle
- Rich markdown body with all specified typography styles
- Code blocks with syntax highlighting and working copy button
- Link field renders as amber external link when present
- Post navigation with prev/next (hide unavailable)
- 404 for invalid slugs
- View Transitions on navigation links
</success_criteria>

<output>
After completion, create `.planning/phases/11-entry-display/11-03-SUMMARY.md`
</output>
